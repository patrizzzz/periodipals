<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Activities - PeriodiPal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            query, 
            where, 
            orderBy,
            limit, 
            updateDoc, 
            setDoc,
            addDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7j5oSrNFAHHIfLQZvEh-VRg_OVqQ4EQ4",
            authDomain: "menstrual-hygiene-manage-6b0ed.firebaseapp.com",
            projectId: "menstrual-hygiene-manage-6b0ed",
            storageBucket: "menstrual-hygiene-manage-6b0ed.firebasestorage.app",
            messagingSenderId: "1002865022115",
            appId: "1:1002865022115:web:ab79150f8a8d82e9171b16",
            measurementId: "G-SSCG3ZV148"
          // Your Firebase config values here
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.auth = auth;
        window.db = db;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.collection = collection;
        window.doc = doc;

        // Make submitActivityAnswers available globally
        window.submitActivityAnswers = async function(activityId, studentId) {
            if (!activityId || !studentId) {
                throw new Error('Activity ID and Student ID are required');
            }

            try {
                const form = document.getElementById('activityForm');
                if (!form) {
                    throw new Error('Activity form not found');
                }

                const questions = form.querySelectorAll('.question');
                if (!questions.length) {
                    throw new Error('No questions found');
                }

                let totalScore = 0;
                let answeredQuestions = 0;
                const answers = [];

                // Process each question
                questions.forEach((question, index) => {
                    const questionText = question.querySelector('.question-text').textContent;
                    const questionType = question.dataset.type || 'multiple-choice';
                    let answer = null;
                    let isCorrect = null;

                    if (questionType === 'multiple-choice' || questionType === 'true-false') {
                        const selectedOption = question.querySelector('input[type="radio"]:checked');
                        if (selectedOption) {
                            answer = selectedOption.value;
                            isCorrect = selectedOption.dataset.correct === 'true';
                            if (isCorrect) totalScore++;
                            answeredQuestions++;
                        }
                    } else if (questionType === 'short-answer') {
                        const textarea = question.querySelector('textarea');
                        if (textarea && textarea.value.trim()) {
                            answer = textarea.value.trim();
                            answeredQuestions++;
                            // Short answers need teacher review
                            isCorrect = null;
                        }
                    }

                    if (answer !== null) {
                        answers.push({
                            questionNumber: index + 1,
                            question: questionText,
                            answer: answer,
                            correct: isCorrect,
                            type: questionType
                        });
                    }
                });

                if (answeredQuestions === 0) {
                    throw new Error('Please answer at least one question');
                }

                // Calculate percentage score based on multiple-choice and true-false questions
                const answeredMCQuestions = answers.filter(a => 
                    (a.type === 'multiple-choice' || a.type === 'true-false') && 
                    a.correct !== null
                ).length;

                const score = answeredMCQuestions > 0 ? 
                    Math.round((totalScore / answeredMCQuestions) * 100) : 0;

                // Submit to Firestore
                const submissionRef = collection(db, `activities/${activityId}/submissions`);
                await addDoc(submissionRef, {
                    studentId: studentId,
                    answers: answers,
                    score: score,
                    totalQuestions: questions.length,
                    answeredQuestions: answeredQuestions,
                    correctAnswers: totalScore,
                    submittedAt: serverTimestamp(),
                    status: 'submitted'
                });

                // Close modal
                document.getElementById('activityModal').classList.remove('show');

                // Show detailed results in a new modal
                const resultsHTML = `
                    <div class="results-summary">
                        <h2>Activity Results</h2>
                        <div class="score-display">
                            <div class="score-circle">
                                <span class="score-number">${score}%</span>
                            </div>
                            <p class="score-details">
                                You got ${totalScore} out of ${answeredMCQuestions} multiple choice questions correct.
                            </p>
                        </div>
                        <div class="answers-review">
                            ${answers.map((answer, idx) => `
                                <div class="answer-item ${answer.correct === true ? 'correct' : answer.correct === false ? 'incorrect' : 'pending'}">
                                    <div class="question">${answer.questionNumber}. ${answer.question}</div>
                                    <div class="answer">Your answer: ${answer.answer}</div>
                                    ${answer.correct !== null ? 
                                        `<div class="status">${answer.correct ? '✓ Correct' : '✗ Incorrect'}</div>` : 
                                        '<div class="status pending">Pending teacher review</div>'
                                    }
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Create and show results modal
                const resultsModal = document.createElement('div');
                resultsModal.className = 'modal results-modal show';
                resultsModal.innerHTML = `
                    <div class="modal-content">
                        <button class="close-btn" onclick="this.closest('.modal').remove();">&times;</button>
                        <div class="modal-body">
                            ${resultsHTML}
                        </div>
                    </div>
                `;
                document.body.appendChild(resultsModal);

                // Add styles for results display
                const styleSheet = document.createElement('style');
                styleSheet.textContent = `
                    .results-summary { padding: 20px; }
                    .score-display { text-align: center; margin: 30px 0; }
                    .score-circle {
                        width: 120px;
                        height: 120px;
                        border-radius: 50%;
                        background: var(--primary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 20px;
                    }
                    .score-number {
                        font-size: 2.5rem;
                        font-weight: bold;
                        color: white;
                    }
                    .score-details { color: var(--text-secondary); margin-bottom: 20px; }
                    .answers-review { max-height: 400px; overflow-y: auto; }
                    .answer-item {
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 10px;
                        background: var(--secondary);
                    }
                    .answer-item.correct { border-left: 4px solid var(--success); }
                    .answer-item.incorrect { border-left: 4px solid var(--danger); }
                    .answer-item.pending { border-left: 4px solid var(--warning); }
                    .answer-item .question { font-weight: 500; margin-bottom: 8px; }
                    .answer-item .answer { margin: 8px 0; }
                    .answer-item .status {
                        margin-top: 8px;
                        font-size: 0.9rem;
                        font-weight: 500;
                    }
                    .answer-item.correct .status { color: var(--success); }
                    .answer-item.incorrect .status { color: var(--danger); }
                    .answer-item.pending .status { color: var(--warning); }
                `;
                document.head.appendChild(styleSheet);

                // Refresh page after 3 seconds to update activity status
                setTimeout(() => {
                    location.reload();
                }, 3000);

            } catch (error) {
                console.error('Error submitting activity:', error);
                console.error('Error details:', error.stack);
                alert('Failed to submit activity: ' + (error.message || 'Please try again.'));
            }
        };
    </script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #f3f4f6;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Navigation */
        .top-nav {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-2px);
        }

        .profile-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Container */
        .activities-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
            position: relative;
        }

        .header-section {
            margin-bottom: 40px;
            text-align: center;
        }

        .header-section h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Filter and Sort Controls */
        .controls-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filter-tab {
            padding: 8px 16px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .sort-dropdown {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        /* Activities Grid */
        .activities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .activity-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px;
            border: 1px solid var(--glass-border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .activity-card:hover::before {
            transform: scaleX(1);
        }

        .activity-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-lg);
            background: rgba(255, 255, 255, 0.35);
        }

        .activity-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }

        .activity-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .activity-info {
            flex: 1;
            min-width: 0;
        }

        .activity-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .activity-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .activity-description {
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .activity-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .due-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid transparent;
            backdrop-filter: blur(10px);
            text-transform: capitalize;
        }

        .status-badge.new {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            border-color: rgba(99, 102, 241, 0.3);
        }

        .status-badge.in-progress {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .status-badge.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .status-badge.overdue {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .priority-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .priority-high {
            background: var(--danger);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .priority-medium {
            background: var(--warning);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .priority-low {
            background: var(--success);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        /* Empty State */
        .empty-state {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state.show {
            display: block;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-tertiary);
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .empty-state .hint {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Loading State */
        .loading-spinner {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 30px;
        }

        .loading-spinner.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin: 0;
        }

        .close-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            margin-bottom: 30px;
        }

        .modal-body p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 8px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .cancel-btn, .submit-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-btn {
            background: var(--secondary);
            border: none;
            color: var(--text-secondary);
        }

        .cancel-btn:hover {
            background: #e5e7eb;
        }

        .submit-btn {
            background: var(--primary);
            border: none;
            color: white;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
        }

        /* Activity Modal Styles */
        .activity-modal-header {
            margin-bottom: 24px;
        }

        .activity-modal-header h2 {
            font-size: 1.8rem;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .activity-meta {
            display: flex;
            gap: 16px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .question {
            background: var(--secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .short-answer {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }

        .short-answer:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        .attempts-list {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .submit-btn {
            margin-top: 24px;
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .activity-card {
            animation: fadeInUp 0.6s ease forwards;
        }

        .activity-card:nth-child(even) {
            animation-delay: 0.1s;
        }

        .activity-card:nth-child(3n) {
            animation-delay: 0.2s;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .activities-container {
                padding: 24px 16px;
            }

            .header-section h1 {
                font-size: 2.2rem;
            }

            .subtitle {
                font-size: 1.1rem;
            }

            .activities-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-tabs {
                justify-content: center;
            }

            .activity-header {
                gap: 16px;
            }

            .activity-icon {
                width: 48px;
                height: 48px;
            }

            .activity-title {
                font-size: 1.2rem;
            }

            .top-nav {
                padding: 12px 16px;
            }
        }

        @media (max-width: 480px) {
            .header-section h1 {
                font-size: 1.8rem;
            }

            .activity-card {
                padding: 20px;
            }

            .activity-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <header class="top-nav">
        <div class="nav-left">
            <a href="/menu" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Menu
            </a>
        </div>
        <div class="nav-right">
            <div class="profile-menu">
                <button class="profile-btn" id="profileBtn">
                    <i class="fas fa-user"></i>
                    <span class="profile-name" id="profileName">Student</span>
                </button>
            </div>
        </div>
    </header>

    <div class="activities-container">
        <div class="header-section">
            <h1>Class Activities</h1>
            <p class="subtitle">Discover, engage, and excel in your classroom adventures. Track your progress and stay connected with your learning journey.</p>
        </div>

        <!-- Filter and Sort Controls -->
        <div class="controls-section">
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All Activities</button>
                <button class="filter-tab" data-filter="new">New</button>
                <button class="filter-tab" data-filter="in-progress">In Progress</button>
                <button class="filter-tab" data-filter="completed">Completed</button>
            </div>
            <select class="sort-dropdown" id="sortDropdown">
                <option value="due-date">Sort by Due Date</option>
                <option value="title">Sort by Title</option>
                <option value="priority">Sort by Priority</option>
                <option value="status">Sort by Status</option>
            </select>
        </div>

        <!-- Loading State -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
        </div>

        <div class="activities-grid" id="activitiesGrid">
            <!-- Activities will be populated dynamically -->
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="empty-state">
            <i class="fas fa-clipboard-list"></i>
            <h3>No Activities Yet</h3>
            <p>Your teacher hasn't assigned any activities yet.</p>
            <p class="hint">Check back later for exciting new learning opportunities!</p>
        </div>
    </div>

    <!-- Teacher Code Dialog -->
    <div id="teacherCodeDialog" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Connect with Your Teacher</h2>
                <button class="close-btn" id="closeTeacherDialog">&times;</button>
            </div>
            <div class="modal-body">
                <p>Please enter the code provided by your teacher to access class activities.</p>
                <div class="input-group">
                    <input type="text" id="teacherCodeInput" placeholder="Enter teacher code" maxlength="6">
                    <div class="error-message" id="teacherCodeError"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" id="cancelTeacherCode">Cancel</button>
                <button class="submit-btn" id="submitTeacherCode">Connect</button>
            </div>
        </div>
    </div>

    <!-- Activity View/Answer Modal -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" id="closeActivityModal">&times;</button>
            <div class="modal-body" id="activityModalBody">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const activitiesGrid = document.getElementById('activitiesGrid');
            const emptyState = document.getElementById('emptyState');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const filterTabs = document.querySelectorAll('.filter-tab');
            const sortDropdown = document.getElementById('sortDropdown');
            const profileName = document.getElementById('profileName');

            let allActivities = [];
            let filteredActivities = [];
            
            // Check authentication state
            window.auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = '/login';
                    return;
                }
                console.log('User authenticated:', user.uid, 'Name:', user.email || 'Unknown');
                
                // Update profile name
                profileName.textContent = user.displayName || 'Student';

                try {
                    // Get student's teacher ID from user document
                    const userDoc = await window.getDoc(window.doc(window.db, 'users', user.uid));
                    const userData = userDoc.data();
                    const teacherId = userData?.teacher_id;  // Changed from teacherId to teacher_id

                    if (teacherId) {
                        // Teacher is already linked, fetch activities directly
                        console.log('Teacher already linked:', teacherId);
                        const teacherName = userData?.teacher_name || 'Unknown Teacher';
                        console.log('Teacher name:', teacherName);
                        await fetchActivities(teacherId, user.uid);
                    } else if (userData?.role === 'student') {
                        // Only show teacher code dialog for students without a teacher
                        console.log('No teacher linked, showing dialog');
                        showTeacherCodeDialog();
                    }
                } catch (error) {
                    console.error('Error checking teacher connection:', error);
                }
            });

            // Dialog helper functions moved to the UI controls section

            async function fetchActivities(teacherId, studentId) {
                try {
                    loadingSpinner.style.display = 'flex';

                    // Get activities from activities collection
                    const activitiesRef = window.collection(window.db, 'activities');
                    const activitiesQuery = window.query(
                        activitiesRef, 
                        window.where('teacherId', '==', teacherId),
                        window.where('status', '==', 'active'),  // Only show active quizzes
                        window.orderBy('dueDate', 'desc')
                    );
                    const activitiesSnapshot = await window.getDocs(activitiesQuery);

                    // Map activities with their types and data
                    allActivities = activitiesSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            type: data.type || 'activity',
                            status: progress[doc.id] || 'new'
                        };
                    });

                    // Get student's progress from their activities subcollection
                    const progressRef = window.collection(window.db, 'users', studentId, 'activities');
                    const progressSnapshot = await window.getDocs(progressRef);

                    const progress = {};
                    progressSnapshot.forEach(doc => {
                        progress[doc.id] = doc.data().status;
                    });

                    // Map activities and quizzes to a common format
                    const activities = activitiesSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            type: 'resource',
                            title: data.title,
                            description: data.description,
                            dueDate: data.dueDate,
                            priority: data.priority || 'medium',
                            status: progress[doc.id] || 'new',
                            createdAt: data.createdAt,
                            attachments: data.attachments || []
                        };
                    });

                    const quizzes = quizzesSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            type: 'quiz',
                            title: data.title,
                            description: data.description,
                            dueDate: data.dueDate || new Date().toISOString(),
                            priority: 'high',
                            status: progress[doc.id] || 'new',
                            duration: data.duration,
                            maxAttempts: data.maxAttempts,
                            passingScore: data.passingScore,
                            createdAt: data.createdAt
                        };
                    });

                    // Combine activities and quizzes
                    allActivities = [...activities, ...quizzes].sort((a, b) => 
                        b.createdAt?.toMillis() - a.createdAt?.toMillis()
                    );

                    // Initial render
                    filteredActivities = [...allActivities];
                    sortActivities('due-date');
                } catch (error) {
                    console.error('Error fetching activities:', error);
                    
                    // Check if error is related to missing index
                    if (error.code === 'failed-precondition' && error.message.includes('index')) {
                        console.log('Missing Index Link:', error.message.match(/https:\/\/console\.firebase\.google\.com\/[^\s]*/)?.[0]);
                        activitiesGrid.innerHTML = '<p class="error">Database index needs to be created. Please check console for the link.</p>';
                    } else {
                        activitiesGrid.innerHTML = '<p class="error">Failed to load activities. Please try again later.</p>';
                    }
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            function getTimeRemaining(dueDate) {
                const now = new Date();
                const due = new Date(dueDate);
                const timeDiff = due - now;
                
                if (timeDiff < 0) {
                    return "Overdue";
                }
                
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                if (days > 0) {
                    return `${days} day${days !== 1 ? 's' : ''} left`;
                } else if (hours > 0) {
                    return `${hours} hour${hours !== 1 ? 's' : ''} left`;
                } else {
                    return "Due soon";
                }
            }

            function createActivityCard(activity) {
                const timeRemaining = getTimeRemaining(activity.dueDate);
                const isOverdue = new Date(activity.dueDate) < new Date();
                
                let icon = 'tasks';
                if (activity.type === 'quiz') {
                    icon = 'question-circle';
                } else if (activity.type === 'resource') {
                    icon = 'book';
                }
                
                return `
                    <div class="activity-card" data-id="${activity.id}" data-type="${activity.type}" data-status="${activity.status}" data-priority="${activity.priority || 'medium'}">
                        <div class="priority-indicator priority-${activity.priority || 'medium'}"></div>
                        <div class="activity-header">
                            <div class="activity-icon">
                                <i class="fas fa-${icon}"></i>
                            </div>
                            <div class="activity-info">
                                <h3 class="activity-title">${activity.title}</h3>
                                <div class="activity-meta">
                                    <span class="activity-type">${activity.type}</span>
                                    ${activity.duration ? `<span>• ${activity.duration} min</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <p class="activity-description">${activity.description || ''}</p>
                        <div class="activity-footer">
                            <div class="due-info">
                                <i class="fas fa-clock"></i>
                                <span>${timeRemaining}</span>
                            </div>
                            <span class="status-badge ${isOverdue && activity.status !== 'completed' ? 'overdue' : activity.status}">
                                ${isOverdue && activity.status !== 'completed' ? 'overdue' : activity.status.replace('-', ' ')}
                            </span>
                        </div>
                    </div>
                `;
            }

            function renderActivities(activities) {
                if (activities.length === 0) {
                    activitiesGrid.innerHTML = '';
                    emptyState.style.display = 'block';
                } else {
                    activitiesGrid.innerHTML = activities.map(createActivityCard).join('');
                    emptyState.style.display = 'none';
                }
            }

            function filterActivities(filterType) {
                if (filterType === 'all') {
                    filteredActivities = [...allActivities];
                } else {
                    filteredActivities = allActivities.filter(activity => {
                        const isOverdue = new Date(activity.dueDate) < new Date() && activity.status !== 'completed';
                        const actualStatus = isOverdue ? 'overdue' : activity.status;
                        return actualStatus === filterType;
                    });
                }
                sortActivities(sortDropdown.value);
            }

            function sortActivities(sortType) {
                switch (sortType) {
                    case 'due-date':
                        filteredActivities.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                        break;
                    case 'title':
                        filteredActivities.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'priority':
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        filteredActivities.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
                        break;
                    case 'status':
                        filteredActivities.sort((a, b) => a.status.localeCompare(b.status));
                        break;
                }
                renderActivities(filteredActivities);
            }

            // Event listeners
            filterTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    filterTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterActivities(tab.dataset.filter);
                });
            });

            sortDropdown.addEventListener('change', (e) => {
                sortActivities(e.target.value);
            });

            // Activity card click handler -> open modal to view/answer
            activitiesGrid.addEventListener('click', async (e) => {
                const activityCard = e.target.closest('.activity-card');
                if (!activityCard) return;
                const activityId = activityCard.dataset.id;
                if (!activityId) return;

                // Feedback animation
                activityCard.style.transform = 'scale(0.98)';
                setTimeout(() => { activityCard.style.transform = ''; }, 100);

                try {
                    // Mark in-progress on first open
                    await window.setDoc(
                        window.doc(window.db, 'users', window.auth.currentUser.uid, 'activities', activityId),
                        { status: 'in-progress', updatedAt: window.serverTimestamp() },
                        { merge: true }
                    );
                } catch (err) {
                    console.warn('Progress update failed (non-blocking):', err);
                }

                openActivityModal(activityId);
            });

            // Teacher code dialog
            const teacherCodeDialog = document.getElementById('teacherCodeDialog');
            const closeTeacherDialog = document.getElementById('closeTeacherDialog');
            const cancelTeacherCode = document.getElementById('cancelTeacherCode');
            const submitTeacherCode = document.getElementById('submitTeacherCode');
            const teacherCodeInput = document.getElementById('teacherCodeInput');
            const teacherCodeError = document.getElementById('teacherCodeError');

            function showLoading(show = true) {
                loadingSpinner.classList[show ? 'add' : 'remove']('show');
            }

            function showEmptyState(show = true) {
                emptyState.classList[show ? 'add' : 'remove']('show');
            }

            function showError(message) {
                teacherCodeError.textContent = message;
                teacherCodeError.classList.add('show');
            }

            function clearError() {
                teacherCodeError.textContent = '';
                teacherCodeError.classList.remove('show');
            }

            function showTeacherCodeDialog() {
                teacherCodeDialog.classList.add('show');
                teacherCodeInput.focus();
            }

            function hideTeacherCodeDialog() {
                teacherCodeDialog.classList.remove('show');
                teacherCodeInput.value = '';
                clearError();
            }

            async function validateTeacherCode(code) {
                try {
                    const response = await fetch('/api/teacher/code/validate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ code })
                    });

                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to validate teacher code');
                    }

                    if (data.success && data.teacher) {
                        // Show success notification
                        const notification = document.createElement('div');
                        notification.className = 'notification success';
                        notification.textContent = `Successfully connected to ${data.teacher.name}'s class!`;
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 3000);
                        
                        // Store teacher info
                        localStorage.setItem('teacherCode', data.teacher.code);
                        localStorage.setItem('teacherId', data.teacher.id);
                        
                        // Close dialog and refresh page
                        const dialog = document.getElementById('teacherCodeDialog');
                        if (dialog) {
                            dialog.style.display = 'none';
                        }
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                        
                        return data.teacher;
                    }
                } catch (error) {
                    // Show error notification
                    const notification = document.createElement('div');
                    notification.className = 'notification error';
                    notification.textContent = error.message;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                    
                    throw error;
                }
            }

            async function linkStudentToTeacher(teacherId) {
                try {
                    await window.updateDoc(window.doc(window.db, 'users', window.auth.currentUser.uid), { 
                        teacher_id: teacherId,
                        updated_at: window.serverTimestamp()
                    });
                    return teacherId;
                } catch (error) {
                    console.error('Error linking student to teacher:', error);
                    throw error;
                }
            }

            async function fetchActivities(teacherId, studentId) {
                try {
                    showLoading(true);
                    showEmptyState(false);

                    // Get activities
                    const activitiesRef = window.collection(window.db, 'activities');
                    const q = window.query(activitiesRef, window.where('teacherId', '==', teacherId), window.where('status', '==', 'active'));
                    const activitiesSnapshot = await window.getDocs(q);

                    // Get student's progress
                    const progressRef = window.collection(window.db, 'users', studentId, 'activities');
                    const progressSnapshot = await window.getDocs(progressRef);
                    const progress = {};
                    progressSnapshot.forEach(doc => {
                        progress[doc.id] = doc.data().status;
                    });

                    if (activitiesSnapshot.empty) {
                        showEmptyState(true);
                        return;
                    }

                    // Map activities with their status
                    allActivities = activitiesSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            status: progress[doc.id] || 'new'
                        };
                    });

                    filteredActivities = [...allActivities];
                    renderActivities(filteredActivities);
                } catch (error) {
                    console.error('Error fetching activities:', error);
                    showEmptyState(true);
                } finally {
                    showLoading(false);
                }
            }

            function renderActivities(activities) {
                activitiesGrid.innerHTML = activities.map(activity => `
                    <div class="activity-card" data-id="${activity.id}" data-status="${activity.status || 'new'}" data-type="${activity.type || 'resource'}">
                        <div class="activity-header">
                            <div class="activity-icon">
                                <i class="${activity.icon || 'fas fa-book'}"></i>
                            </div>
                            <div class="activity-info">
                                <h3 class="activity-title">${activity.title}</h3>
                                <div class="activity-meta">
                                    <span class="due-info">Due: ${new Date(activity.dueDate).toLocaleDateString()}</span>
                                    <span class="status-badge ${activity.status}">${activity.status}</span>
                                </div>
                            </div>
                        </div>
                        <p class="activity-description">${activity.description}</p>
                        <div class="activity-footer">
                            <div class="priority-indicator ${activity.priority}"></div>
                        </div>
                    </div>
                `).join('');
            }

            // Modal elements
            const activityModal = document.getElementById('activityModal');
            const activityModalClose = document.getElementById('closeActivityModal');
            const activityModalBody = document.getElementById('activityModalBody');

            // Modal close helpers to avoid lag from leftover inline display styles
            const hideActivityModal = () => {
                if (!activityModal) return;
                activityModal.classList.remove('show');
                // wait for transition then fully hide and cleanup content to free memory
                setTimeout(() => {
                    activityModal.style.display = 'none';
                    if (activityModalBody) activityModalBody.innerHTML = '';
                }, 200);
            };

            if (activityModalClose) {
                activityModalClose.addEventListener('click', hideActivityModal, { once: false });
            }
            // Close when clicking outside content (backdrop)
            if (activityModal) {
                activityModal.addEventListener('click', (e) => {
                    if (e.target === activityModal) hideActivityModal();
                });
            }
            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && activityModal && activityModal.classList.contains('show')) {
                    hideActivityModal();
                }
            });

            async function openActivityModal(activityId) {
                try {
                    loadingSpinner.style.display = 'flex';
                    const activityDoc = await window.getDoc(window.doc(window.db, 'activities', activityId));
                    if (!activityDoc.exists()) {
                        throw new Error('Activity not found');
                    }

                    const activity = { ...activityDoc.data(), id: activityId };
                    console.log('Activity data:', activity); // Debug log
                    
                    const studentId = window.auth.currentUser.uid;

                    // Get student's attempts for this activity
                    const attemptsRef = window.collection(window.db, `activities/${activityId}/submissions`);
                    const attemptsQuery = window.query(attemptsRef, window.where('studentId', '==', studentId));
                    const attemptsSnapshot = await window.getDocs(attemptsQuery);
                    
                    const attempts = attemptsSnapshot.docs.map(doc => doc.data());
                    const attemptsLeft = activity.maxAttempts ? activity.maxAttempts - attempts.length : 1;

                    const content = renderActivityContent(activity, attemptsLeft, attempts);
                    activityModalBody.innerHTML = content;
                    
                    // Make modal visible
                    activityModal.style.display = 'flex';
                    requestAnimationFrame(() => activityModal.classList.add('show'));
                } catch (e) {
                    console.error('Error opening activity:', e);
                    alert('Failed to open activity: ' + e.message);
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            function renderActivityContent(activity, attemptsLeft, attempts) {
                console.log('Rendering activity:', activity); // Debug log
                const header = `
                    <div class="activity-modal-header">
                        <h2>${activity.title || 'Untitled Activity'}</h2>
                        <div class="activity-meta">
                            <span class="due-date">Due: ${activity.dueDate ? new Date(activity.dueDate).toLocaleString() : 'No due date'}</span>
                            <span class="attempts">Attempts Left: ${attemptsLeft}</span>
                        </div>
                        <p class="description">${activity.description || ''}</p>
                    </div>
                `;

                if (activity.type === 'quiz' && Array.isArray(activity.questions)) {
                    const questionsHtml = activity.questions.map((question, idx) => {
                        switch(question.type) {
                            case 'multiple-choice':
                                return `
                                    <div class="question" data-type="multiple-choice" data-id="${idx}">
                                        <p class="question-text">${idx + 1}. ${question.text}</p>
                                        <div class="options">
                                            ${question.options.map((option, optIdx) => `
                                                <label class="option">
                                                    <input type="radio" name="q${idx}" value="${optIdx}" data-correct="${option.isCorrect === true}">
                                                    <span>${option.text}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            case 'true-false':
                                return `
                                    <div class="question" data-type="true-false" data-id="${idx}">
                                        <p class="question-text">${idx + 1}. ${question.text}</p>
                                        <div class="options">
                                            <label class="option">
                                                <input type="radio" name="q${idx}" value="true" data-correct="${question.correctAnswer === true}">
                                                <span>True</span>
                                            </label>
                                            <label class="option">
                                                <input type="radio" name="q${idx}" value="false" data-correct="${question.correctAnswer === false}">
                                                <span>False</span>
                                            </label>
                                        </div>
                                    </div>
                                `;
                            case 'short-answer':
                                return `
                                    <div class="question" data-id="${idx}">
                                        <p class="question-text">${idx + 1}. ${question.text}</p>
                                        <textarea class="short-answer" name="q${idx}" rows="3" placeholder="Type your answer here..."></textarea>
                                    </div>
                                `;
                            default:
                                return '';
                        }
                    }).join('');

                    const submitButton = attemptsLeft > 0 ? `
                        <button class="submit-btn" onclick="submitActivityAnswers('${activity.id}', '${window.auth.currentUser.uid}')">
                            Submit Answers
                        </button>
                    ` : '';

                    return `
                        ${header}
                        <form id="activityForm" class="questions-container">
                            ${questionsHtml}
                            ${submitButton}
                        </form>
                        ${renderAttemptsList(attempts)}
                    `;
                }

                // Non-quiz activity: show description and attachments if any
                const attachments = Array.isArray(activity.attachments) ? activity.attachments : [];
                const attHtml = attachments.length ? `<div class="attachments">${attachments.map(a => `<a href="${a.url}" target="_blank">${a.name || 'Attachment'}</a>`).join('')}</div>` : '';
                return header + attHtml;
            }

            function renderAttemptsList(attempts) {
                if (!attempts || !attempts.length) return '';
                return `<div class="attempts-list">
                    <h4>Previous Attempts</h4>
                    <ul>
                        ${attempts.map(a => `<li>${new Date(a.submittedAt?.toDate ? a.submittedAt.toDate() : a.submittedAt).toLocaleString()} - Score: ${a.score ?? '-'}%</li>`).join('')}
                    </ul>
                </div>`;
            }

            async function submitActivityAnswers(activityId, studentId) {
                try {
                    const form = document.getElementById('activityForm');
                    const questions = form.querySelectorAll('.question');
                    const answers = [];
                    let correctAnswers = 0;
                    let totalQuestions = questions.length;

                    // Get the activity data to access correct answers
                    const activityDoc = await window.getDoc(window.doc(window.db, 'activities', activityId));
                    if (!activityDoc.exists()) {
                        throw new Error('Activity not found');
                    }
                    const activity = activityDoc.data();

                    questions.forEach((question, index) => {
                        const questionId = question.dataset.id;
                        const questionType = question.querySelector('textarea') ? 'short-answer' : 
                                          question.querySelector('[value="true"]') ? 'true-false' : 'multiple-choice';
                        
                        let answer;
                        let isCorrect = false;
                        
                        if (questionType === 'short-answer') {
                            answer = question.querySelector('textarea').value;
                            // For short answer, check if answer matches (case insensitive)
                            const correctAnswer = activity.questions[index]?.correctAnswer;
                            if (correctAnswer && answer.toLowerCase().trim() === correctAnswer.toLowerCase().trim()) {
                                isCorrect = true;
                                correctAnswers++;
                            }
                        } else {
                            const selected = question.querySelector('input:checked');
                            if (selected) {
                                answer = selected.value;
                                isCorrect = selected.dataset.correct === 'true';
                                if (isCorrect) {
                                    correctAnswers++;
                                }
                            }
                        }

                        answers.push({
                            questionId,
                            answer,
                            type: questionType,
                            isCorrect: isCorrect,
                            question: activity.questions[index]?.text || `Question ${index + 1}`,
                            correctAnswer: questionType === 'multiple-choice' ? 
                                activity.questions[index]?.options?.find(opt => opt.isCorrect)?.text :
                                activity.questions[index]?.correctAnswer
                        });
                    });

                    // Calculate score
                    const score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

                    // Submit to Firestore
                    const submissionRef = window.collection(window.db, `activities/${activityId}/submissions`);
                    await window.addDoc(submissionRef, {
                        studentId,
                        answers,
                        score: score,
                        correctAnswers: correctAnswers,
                        totalQuestions: totalQuestions,
                        submittedAt: window.serverTimestamp()
                    });

                    // Update student's activity progress
                    await window.setDoc(
                        window.doc(window.db, 'users', studentId, 'activities', activityId),
                        { 
                            status: 'completed', 
                            score: score,
                            completedAt: window.serverTimestamp(),
                            updatedAt: window.serverTimestamp()
                        },
                        { merge: true }
                    );

                    document.getElementById('activityModal').classList.remove('show');
                    alert(`Activity submitted successfully! Your score: ${score}%`);
                    
                } catch (e) {
                    console.error('Error submitting activity:', e);
                    alert('Failed to submit activity. Please try again.');
                }
            }

            // Event listeners
            closeTeacherDialog.addEventListener('click', hideTeacherCodeDialog);
            cancelTeacherCode.addEventListener('click', hideTeacherCodeDialog);

            submitTeacherCode.addEventListener('click', async () => {
                const code = teacherCodeInput.value.trim().toUpperCase();
                if (!code) {
                    showError('Please enter a teacher code');
                    return;
                }

                try {
                    submitTeacherCode.disabled = true;
                    const teacherId = await validateTeacherCode(code);
                    await linkStudentToTeacher(teacherId);
                    hideTeacherCodeDialog();
                    await fetchActivities(teacherId);
                } catch (error) {
                    showError(error.message || 'Invalid teacher code');
                } finally {
                    submitTeacherCode.disabled = false;
                }
            });

            // Initial load handled by onAuthStateChanged
        });
    </script>
</body>
</html>